<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Airport Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      body {
        font-family: sans-serif;
      }
      #map {
        height: 800px;
        width: 100%;
        margin-top: 1em;
      }
      #airportSelect {
        margin: 1em 0;
        font-size: 1em;
      }
    </style>
  </head>
  <body>
    <h1>Airport Viewer</h1>

    <label for="airportSelect">Choose an airport:</label>
    <select id="airportSelect"></select>

    <div id="map"></div>
    <div id="infoBox"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      "use strict";
      let map;
      let marker;
      let airportCode = "JFK";
      let airportData = {};

      async function loadAirportList() {
        try {
          const res = await fetch("../data/airports.csv");
          const text = await res.text();
          const lines = text.trim().split("\n").slice(1);  // Skip header
          const select = document.getElementById("airportSelect");

          for (const line of lines) {
            const fields = line.split(";").map(f => f.trim());
            const iata = fields[1];
            const name = fields[2];
            const lat = parseFloat(fields[3]);
            const lon = parseFloat(fields[4]);

            if (!iata || !name || isNaN(lat) || isNaN(lon)) continue;

            airportData[iata.toUpperCase()] = { name, lat, lon };

            const option = document.createElement("option");
            option.value = iata.toUpperCase();
            option.textContent = `${iata.toUpperCase()} – ${name}`;
            select.appendChild(option);
          }

          select.value = airportCode;
          select.addEventListener("change", (e) => {
            airportCode = e.target.value;
            loadAirportInfo();
          });

          loadAirportInfo();
        } catch (err) {
          console.error("Airport list fetch failed:", err);
        }
      }
      
      function loadAirportInfo() {
        const infoBox = document.getElementById("infoBox");
        const data = airportData[airportCode];
        if (!data) {
          infoBox.innerHTML = `<p>No data available for ${airportCode}</p>`;
          return;
        }

        infoBox.innerHTML = `
          <h2>${airportCode} – ${data.name}</h2>
          <p>Coordinates: ${data.lat}, ${data.lon}</p>
        `;

        const coords = [data.lat, data.lon];
        map.setView(coords, 10);

        if (marker) {
          marker.setLatLng(coords);
        } else {
          marker = L.marker(coords).addTo(map);
        }
      }

      function initMap() {
        map = L.map("map").setView([40.6413, -73.7781], 10); // JFK default
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);
      }

      window.onload = () => {
        initMap();
        loadAirportList();
      };
    </script>
  </body>
</html>
