<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Airport Details</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 400px; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    .checkmark { color: green; font-weight: bold; }
  </style>
</head>
<body>
  <h2 id="summary">Loading...</h2>
  <div id="map"></div>
  <table id="visitTable">
    <thead>
      <tr><th>User</th><th>Arrival</th><th>Departure</th><th>Layover</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const airportCode = location.hash ? location.hash.substring(1).toUpperCase() : "JFK";
    <script>
      console.log("Airport code is", airportCode);
    </script>
    let airportData, users = [];

    async function loadAirportInfo() {
      const res = await fetch('../data/airports.csv');
      const text = await res.text();
      const lines = text.trim().split('\n');
      for (const line of lines) {
        const [code, name, lat, lon] = line.split(',');
        if (code === airportCode) {
          airportData = { code, name, lat: +lat, lon: +lon };
          break;
        }
      }
      if (!airportData) {
        document.getElementById('summary').textContent = 'Airport not found';
        return;
      }
      document.getElementById('summary').textContent = `Loading data for ${airportData.name}...`;
      initMap();
      await loadUserVisits();
    }

    function initMap() {
      const map = L.map('map').setView([airportData.lat, airportData.lon], 13);
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);
      L.marker([airportData.lat, airportData.lon]).addTo(map)
        .bindPopup(airportData.name).openPopup();
    }

    async function loadUserVisits() {
      const userListRes = await fetch('../data/users.txt');
      const userList = (await userListRes.text()).trim().split('\n');

      let visitCount = 0;
      for (const user of userList) {
        const alistRes = await fetch(`../data/${user}.alist`);
        if (!alistRes.ok) continue;
        const entries = (await alistRes.text()).trim().split('\n');
        for (const entry of entries) {
          const parts = entry.split(/\s+/);
          if (parts[0] === airportCode) {
            visitCount++;
            const flags = { A: false, D: false, L: false };
            parts.slice(1).forEach(x => { if (flags.hasOwnProperty(x)) flags[x] = true });
            users.push({ name: user, ...flags });
            break;
          }
        }
      }
      document.getElementById('summary').textContent = 
        `${visitCount} user${visitCount !== 1 ? 's' : ''} have visited ${airportData.name}`;
      renderTable();
    }

    function renderTable() {
      const tbody = document.querySelector('#visitTable tbody');
      for (const user of users) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${user.name}</td>
          <td>${user.A ? '✅' : ''}</td>
          <td>${user.D ? '✅' : ''}</td>
          <td>${user.L ? '✅' : ''}</td>
        `;
        tbody.appendChild(row);
      }
    }

    loadAirportInfo();
  </script>
</body>
</html>
