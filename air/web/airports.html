<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Airport Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; max-width: 1000px; margin: auto; padding: 1em; }
    #map { height: 600px; width: 100%; margin-bottom: 1em; }
    #visitContainer { margin-top: 2em; }
    #visitTable { border-collapse: collapse; width: 100%; }
    #visitTable th, #visitTable td {
      border: 1px solid #ccc;
      padding: 0.4em 0.6em;
      text-align: center;
    }
    #visitTable th { background-color: #eee; }
  </style>
</head>
<body>

<h1>Airport Viewer</h1>

<label for="airportSelect"><strong>Select Airport:</strong></label>
<select id="airportSelect"></select>

<div id="map"></div>

<div id="visitContainer">
  <h2>Visitors to <span id="airportCodeDisplay">[Select Airport]</span></h2>
  <p>Total Visitors: <span id="visitorCount">0</span></p>
  <table id="visitTable"></table>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const userVisits = {};
const allAirports = new Set();
const airportCoords = {
  "ORD": [41.9742, -87.9073],
  "DTW": [42.2162, -83.3554],
  "JFK": [40.6413, -73.7781],
  "LAX": [33.9416, -118.4085],
  "ATL": [33.6407, -84.4277],
  "DEN": [39.8561, -104.6737]
  // Extend this as needed
};

function parseAlist(username, text) {
  const lines = text.trim().split("\n");
  for (const line of lines) {
    const [iata, ...flags] = line.trim().split(/\s+/);
    if (!iata.match(/^[A-Z]{3}$/)) continue;
    if (!userVisits[iata]) userVisits[iata] = {};
    userVisits[iata][username] = flags;
    allAirports.add(iata);
  }
}

function renderVisitTable(airportCode) {
  document.getElementById("airportCodeDisplay").textContent = airportCode;
  const table = document.getElementById("visitTable");
  table.innerHTML = "";

  const visits = userVisits[airportCode] || {};
  const headers = ["User", "Arrived", "Departed", "Layover"];

  const thead = document.createElement("thead");
  const headerRow = document.createElement("tr");
  headers.forEach(h => {
    const th = document.createElement("th");
    th.textContent = h;
    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  let count = 0;
  for (const [user, types] of Object.entries(visits)) {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${user}</td>
      <td>${types.includes("A") ? "✅" : ""}</td>
      <td>${types.includes("D") ? "✅" : ""}</td>
      <td>${types.includes("L") ? "✅" : ""}</td>
    `;
    tbody.appendChild(row);
    count++;
  }
  table.appendChild(tbody);

  document.getElementById("visitorCount").textContent = count;
}

function populateDropdown() {
  const select = document.getElementById("airportSelect");
  Array.from(allAirports).sort().forEach(code => {
    const opt = document.createElement("option");
    opt.value = code;
    opt.textContent = code;
    select.appendChild(opt);
  });

  select.addEventListener("change", () => {
    const code = select.value;
    renderVisitTable(code);
    if (airportCoords[code]) {
      map.setView(airportCoords[code], 11);
    }
  });

  // Auto-trigger default airport
  if (select.options.length > 0) {
    select.value = "ORD";
    select.dispatchEvent(new Event("change"));
  }
}

// Initialize map
const map = L.map('map').setView([41.9742, -87.9073], 11);  // Default: ORD

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Load contributor list from manifest.json
fetch("https://raw.githubusercontent.com/TravelMapping/AirportData/master/air/data/manifest.json")
  .then(res => res.ok ? res.json() : Promise.reject("manifest.json not found"))
  .then(manifest => {
    const users = Object.keys(manifest);
    const promises = users.map(user =>
      fetch(`https://raw.githubusercontent.com/TravelMapping/AirportData/master/air/data/${user}.alist`)
        .then(res => res.ok ? res.text() : Promise.reject(`${user}.alist missing`))
        .then(text => parseAlist(user, text))
        .catch(err => console.warn("Skipping", err))
    );

    Promise.allSettled(promises).then(() => populateDropdown());
  })
  .catch(err => console.error("Failed to load manifest:", err));
</script>
</body>
</html>
