<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Airport Viewer</title>
  <link rel="stylesheet" href="air/view/view.css">
  <script src="air/view/view.js" defer></script>
  <script type="module" src="air/view/selector.js"></script>
</head>
<body>
  <h1>Airport Viewer</h1>

  <label for="airport-select">Choose an airport:</label>
  <select id="airport-select"></select>

  <section id="map-section">
    <h2>Location</h2>
    <div id="airport-map">Loading mapâ€¦</div>
  </section>

  <section id="visitors">
    <h2>Visitors</h2>
    <table id="visitor-table">
      <thead>
        <tr><th>Name</th><th>Visited</th><th>Notes</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <script>
    const airportSelect = document.getElementById("airport-select");
    const visitorTableBody = document.querySelector("#visitor-table tbody");

    async function loadAirports() {
      const csvUrl = "air/data/airports.csv";
      const response = await fetch(csvUrl);
      const text = await response.text();
      const rows = text.trim().split("\n").map(line => line.split(","));
      const headers = rows.shift();
      const data = rows.map(row => Object.fromEntries(row.map((val, i) => [headers[i], val])));
      for (const airport of data) {
        const option = document.createElement("option");
        option.value = airport.iata;
        option.textContent = `${airport.name} (${airport.iata})`;
        airportSelect.appendChild(option);
      }
    }

    async function loadVisitors(iataCode) {
      const jsonUrl = "air/data/manifest.json";
      const response = await fetch(jsonUrl);
      const manifest = await response.json();
      const entry = manifest.find(item => item.iata === iataCode);
      if (!entry) return;

      const alistUrl = `air/data/${entry.username}.alist`;
      const alistResp = await fetch(alistUrl);
      const alistText = await alistResp.text();
      const rows = alistText.trim().split("\n").map(line => line.split(","));
      const headers = rows.shift();
      const visitorData = rows.map(row => Object.fromEntries(row.map((val, i) => [headers[i], val])));

      visitorTableBody.innerHTML = "";
      for (const visitor of visitorData) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${visitor.name}</td><td>${visitor.date}</td><td>${visitor.notes}</td>`;
        visitorTableBody.appendChild(tr);
      }
    }

    airportSelect.addEventListener("change", (e) => {
      const selected = e.target.value;
      loadVisitors(selected);
    });

    loadAirports();
  </script>
</body>
</html>
