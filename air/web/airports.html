<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Airport Visits</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #map { height: 400px; margin-top: 1em; }
    table { border-collapse: collapse; margin-top: 1em; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: center; }
    th { background: #eee; }
  </style>
</head>
<body>
  <h1>Airport Visit Tracker</h1>
  <label for="airportSelect">Select an airport:</label>
  <select id="airportSelect">
    <option value="">-- Choose --</option>
  </select>

  <div id="map"></div>
  <h2 id="visitCount"></h2>
  <table id="visitTable" style="display:none;">
    <thead>
      <tr>
        <th>User</th>
        <th>Arrival</th>
        <th>Departure</th>
        <th>Layover</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const csvUrl = '../data/airports.csv';
    const manifestUrl = '../data/manifest.json';
    const dataPath = '../data/';

    let airports = {};
    let airportList = [];

    async function fetchAirports() {
      const res = await fetch(csvUrl);
      const text = await res.text();
      const lines = text.trim().split('\n');
      lines.shift(); // remove header
      for (const line of lines) {
        const [country, code, name, lat, lon] = line.split(';');
        if (!code) continue;
        airports[code.toUpperCase()] = {
          code: code.toUpperCase(),
          name,
          lat: parseFloat(lat),
          lon: parseFloat(lon)
        };
        airportList.push({ code: code.toUpperCase(), name });
      }
      populateDropdown();
    }

    function populateDropdown() {
      const sel = document.getElementById('airportSelect');
      for (const airport of airportList.sort((a,b) => a.code.localeCompare(b.code))) {
        const opt = document.createElement('option');
        opt.value = airport.code;
        opt.textContent = `${airport.code} - ${airport.name}`;
        sel.appendChild(opt);
      }
    }

    async function fetchManifest() {
      const res = await fetch(manifestUrl);
      return await res.json(); // returns an array of usernames
    }

    async function fetchAlist(username) {
      const res = await fetch(`${dataPath}${username}.alist`);
      const text = await res.text();
      return text.split('\n').filter(line => !line.startsWith('#'));
    }

    function parseAlist(lines, selectedCode) {
      const result = {};
      for (const line of lines) {
        const [code, ...flags] = line.trim().split(/\s+/);
        if (!code || !flags) continue;
        if (code.toUpperCase() !== selectedCode) continue;
        for (const flag of flags) {
          for (const ch of flag.toUpperCase()) {
            if ('ADL'.includes(ch)) result[ch] = true;
          }
        }
      }
      return result;
    }

    async function handleAirportSelect(code) {
      const airport = airports[code];
      if (!airport) return;

      map.setView([airport.lat, airport.lon], 13);
      marker.setLatLng([airport.lat, airport.lon]).bindPopup(`${airport.code} - ${airport.name}`).openPopup();

      const manifest = await fetchManifest();
      const visitData = {};
      for (const user of manifest) {
        try {
          const lines = await fetchAlist(user);
          const visits = parseAlist(lines, code);
          if (Object.keys(visits).length > 0) {
            visitData[user] = visits;
          }
        } catch (e) {
          console.warn(`Error loading ALIST for ${user}`);
        }
      }

      updateTable(visitData);
    }

    function updateTable(data) {
      const tbody = document.querySelector('#visitTable tbody');
      tbody.innerHTML = '';
      const users = Object.keys(data).sort();
      document.getElementById('visitTable').style.display = users.length ? 'table' : 'none';
      document.getElementById('visitCount').textContent = `${users.length} user(s) have visited this airport.`;

      for (const user of users) {
        const row = document.createElement('tr');
        const tdUser = document.createElement('td');
        tdUser.textContent = user;
        row.appendChild(tdUser);
        for (const type of ['A', 'D', 'L']) {
          const td = document.createElement('td');
          td.textContent = data[user][type] ? 'âœ”' : '';
          row.appendChild(td);
        }
        tbody.appendChild(row);
      }
    }

    // Map setup
    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const marker = L.marker([0, 0]).addTo(map);

    document.getElementById('airportSelect').addEventListener('change', (e) => {
      handleAirportSelect(e.target.value.toUpperCase());
    });

    // Init
    fetchAirports();
  </script>
</body>
</html>
