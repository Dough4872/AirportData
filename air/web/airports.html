<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Airport Viewer</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 1em; }
    h1 { text-align: center; }
    select { font-size: 1em; padding: 0.3em; }
    #airport-map { width: 100%; height: 300px; background: #f0f0f0; border: 1px solid #ccc; margin-top: 1em; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: center; }
    th { background-color: #eee; }
  </style>
</head>
<body>
  <h1>Airport Viewer</h1>

  <label for="airport-select">Choose an airport:</label>
  <select id="airport-select"></select>

  <section id="map-section">
    <h2>Location</h2>
    <div id="airport-map">Map placeholder for selected airport</div>
  </section>

  <section id="visitors">
    <h2>Visitors</h2>
    <table id="visitor-table">
      <thead>
        <tr>
          <th>Username</th><th>Arrival</th><th>Departure</th><th>Layover</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <script>
    const airportSelect = document.getElementById("airport-select");
    const visitorTableBody = document.querySelector("#visitor-table tbody");
    const mapDiv = document.getElementById("airport-map");

    async function loadAirports() {
      const response = await fetch("../data/airports.csv");
      const text = await response.text();
      const rows = text.trim().split("\n").map(line => line.split(";"));
      const headers = rows[0];
      const nameIndex = headers.indexOf("name");
      const codeIndex = headers.indexOf("iata_code");

      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (row.length <= Math.max(nameIndex, codeIndex)) continue;
        const name = row[nameIndex];
        const code = row[codeIndex];
        const option = document.createElement("option");
        option.value = code;
        option.textContent = `${name} (${code})`;
        airportSelect.appendChild(option);
      }
    }

    function updateMap(iataCode) {
      mapDiv.textContent = `Map placeholder for ${iataCode}`;
    }

    async function loadVisitors(iataCode) {
      visitorTableBody.innerHTML = "";
      const manifestResp = await fetch("../data/manifest.json");
      const manifest = await manifestResp.json();

      for (const entry of manifest) {
        const alistUrl = `../data/${entry.username}.alist`;
        try {
          const alistResp = await fetch(alistUrl);
          const alistText = await alistResp.text();
          const lines = alistText.trim().split("\n");

          for (const line of lines) {
            const trimmed = line.trim();
            if (!trimmed || trimmed.startsWith("#")) continue;

            const [code, ...roles] = trimmed.split(/\s+/);
            if (code === iataCode) {
              const hasA = roles.includes("A");
              const hasD = roles.includes("D");
              const hasL = roles.includes("L");

              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${entry.username}</td>
                <td>${hasA ? "✅" : ""}</td>
                <td>${hasD ? "✅" : ""}</td>
                <td>${hasL ? "✅" : ""}</td>
              `;
              visitorTableBody.appendChild(tr);
            }
          }
        } catch (err) {
          console.error(`Error loading ${entry.username}.alist:`, err);
        }
      }
    }

    airportSelect.addEventListener("change", (e) => {
      const selected = e.target.value;
      updateMap(selected);
      loadVisitors(selected);
    });

    loadAirports();
  </script>
</body>
</html>
