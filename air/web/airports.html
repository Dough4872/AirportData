<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Airport Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      body {
        font-family: sans-serif;
      }
      #map {
        height: 800px;
        width: 100%;
        margin-top: 1em;
      }
      #airportSelect {
        margin: 1em 0;
        font-size: 1em;
      }
    </style>
  </head>
  <body>
    <h1>Airport Viewer</h1>

    <label for="airportSelect">Choose an airport:</label>
    <select id="airportSelect"></select>

    <div id="map"></div>
    <div id="infoBox"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      "use strict";
      let map;
      let marker;
      let airportCode = "JFK";
      let airportData = {};

      async function loadAirportList() {
        try {
          const res = await fetch("../data/airports-master.csv");
          const text = await res.text();
          const lines = text.trim().split("\n");
          const select = document.getElementById("airportSelect");

          for (const line of lines) {
            const [country, iata, name, lat, lon] = line.split(";").map(f => f.trim());
            if (!iata || !lat || !lon) continue;

            airportData[iata.toUpperCase()] = {
              name,
              country,
              lat: parseFloat(lat),
              lon: parseFloat(lon)
            };

            const option = document.createElement("option");
            option.value = iata.toUpperCase();
            option.textContent = `${name} (${iata.toUpperCase()})`;
            select.appendChild(option);
          }

          select.value = airportCode;
          select.addEventListener("change", (e) => {
            airportCode = e.target.value;
            loadAirportInfo();
          });

          loadAirportInfo();
        } catch (err) {
          console.error("Airport list fetch failed:", err);
        }
      }

      function loadAirportInfo() {
        const infoBox = document.getElementById("infoBox");
        const data = airportData[airportCode];
        if (!data) {
          infoBox.innerHTML = `<p>No data available for ${airportCode}</p>`;
          return;
        }

        infoBox.innerHTML = `
          <h2>${data.name} (${airportCode})</h2>
          <p>Country: ${data.country}</p>
          <p>Coordinates: ${data.lat}, ${data.lon}</p>
        `;

        const coords = [data.lat, data.lon];
        map.setView(coords, 10);

        if (marker) {
          marker.setLatLng(coords);
        } else {
          marker = L.marker(coords).addTo(map);
        }
      }

      function initMap() {
        map = L.map("map").setView([40.6413, -73.7781], 10); // JFK default
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);
      }

      window.onload = () => {
        initMap();
        loadAirportList();
      };
    </script>
  </body>
</html>
