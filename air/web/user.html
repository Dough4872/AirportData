<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Airport Visits</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #map { height: 500px; margin-top: 1em; }
    table { border-collapse: collapse; width: 100%; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: center; }
    th { background: #eee; }
  </style>
</head>
<body>
  <h1 id="userTitle">User's Visited Airports</h1>
  <label for="userSelect">Select user:</label>
  <select id="userSelect"></select>

  <div id="map"></div>

  <table id="visitTable">
    <thead>
      <tr>
        <th>Country</th>
        <th>IATA</th>
        <th>Airport Name</th>
        <th>Arrival</th>
        <th>Departure</th>
        <th>Layover</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const csvUrl = '../data/airports.csv';
    const manifestUrl = '../data/manifest.json';
    const dataPath = '../data/';

    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    let markers = [];

    let airports = {};
    let airportList = [];

    async function loadAirports() {
      const res = await fetch(csvUrl);
      const text = await res.text();
      const lines = text.trim().split('\n');
      lines.shift(); // remove header
      for (const line of lines) {
        const [country, code, name, lat, lon] = line.split(';');
        if (!code) continue;
        airports[code.toUpperCase()] = {
          code: code.toUpperCase(),
          name,
          lat: parseFloat(lat),
          lon: parseFloat(lon),
          country
        };
      }
    }

    function getUserParam() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('user') || '';
    }

    async function loadManifest() {
      const res = await fetch(manifestUrl);
      return await res.json(); // array of usernames
    }

    function svgMarkerHTML(hasA, hasD, hasL) {
      const fillA = hasA ? "green" : "white";
      const fillD = hasD ? "red" : "white";
      const fillL = hasL ? "none" : "white";
      return `
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40">
          ${hasL ? '<circle cx="20" cy="20" r="15" stroke="blue" stroke-width="3" fill="none" />' : ''}
          <polygon points="20,5 25,15 15,15" fill="${fillD}" stroke="black" />
          <polygon points="20,35 25,25 15,25" fill="${fillA}" stroke="black" />
        </svg>`;
    }

    function createSVGIcon(hasA, hasD, hasL) {
      return L.divIcon({
        html: svgMarkerHTML(hasA, hasD, hasL),
        iconSize: [40, 40],
        className: ''
      });
    }

    function parseAlist(lines) {
      const visits = {};
      for (const line of lines) {
        if (line.startsWith('#')) continue;
        const [code, ...flags] = line.trim().split(/\s+/);
        const iata = code.toUpperCase();
        if (!airports[iata]) continue;
        const types = flags.join('').toUpperCase();
        visits[iata] = {
          A: types.includes('A'),
          D: types.includes('D'),
          L: types.includes('L')
        };
      }
      return visits;
    }

    function renderTable(visitData) {
      const tbody = document.querySelector('#visitTable tbody');
      tbody.innerHTML = '';
      for (const iata of Object.keys(visitData).sort()) {
        const airport = airports[iata];
        const row = document.createElement('tr');
        ['country', 'code', 'name'].forEach(key => {
          const td = document.createElement('td');
          td.textContent = airport[key];
          row.appendChild(td);
        });
        ['A', 'D', 'L'].forEach(type => {
          const td = document.createElement('td');
          td.textContent = visitData[iata][type] ? 'âœ”' : '';
          row.appendChild(td);
        });
        tbody.appendChild(row);
      }
    }

    function updateMap(visitData) {
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      const bounds = [];
      for (const iata in visitData) {
        const { lat, lon, name } = airports[iata];
        const { A, D, L } = visitData[iata];
        const icon = createSVGIcon(A, D, L);
        const marker = L.marker([lat, lon], { icon }).addTo(map);
        marker.bindPopup(`<b>${iata} - ${name}</b><br><a href="airports.html?airport=${iata}">View details</a>`);
        markers.push(marker);
        bounds.push([lat, lon]);
      }
      if (bounds.length > 0) map.fitBounds(bounds, { padding: [30, 30] });
    }

    async function handleUserChange(user) {
      document.getElementById('userTitle').textContent = `${user}'s Visited Airports`;
      history.replaceState(null, '', `?user=${user}`);

      const res = await fetch(`${dataPath}${user}.alist`);
      const lines = (await res.text()).split('\n');
      const visitData = parseAlist(lines);
      renderTable(visitData);
      updateMap(visitData);
    }

    async function init() {
      await loadAirports();
      const users = await loadManifest();
      const sel = document.getElementById('userSelect');
      sel.innerHTML = '';
      users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u;
        opt.textContent = u;
        sel.appendChild(opt);
      });

      const paramUser = getUserParam() || users[0];
      sel.value = paramUser;
      handleUserChange(paramUser);

      sel.addEventListener('change', e => handleUserChange(e.target.value));
    }

    init();
  </script>
</body>
</html>
